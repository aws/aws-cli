#!/usr/bin/env python
import glob
import os
import shutil
import sys
from subprocess import check_call

_dname = os.path.dirname

REPO_ROOT = _dname(_dname(_dname(os.path.abspath(__file__))))
os.chdir(REPO_ROOT)


def run(command):
    return check_call(command, shell=True)


if sys.version_info[:2] >= (3, 12):
    # Python 3.12+ no longer includes setuptools by default.

    # Setuptools 71+ now prefers already installed versions
    # of packaging _and_ broke the API for packaging<22.0.
    # We'll pin to match what's in requirements-dev.txt.
    run("pip install setuptools==71.1.0 packaging==24.1")

run("python -m pip install --no-build-isolation -r requirements-dev-lock.txt")
run(
    "python -m pip install --no-build-isolation -r requirements/download-deps/bootstrap-lock.txt"
)
if os.path.isdir("dist") and os.listdir("dist"):
    shutil.rmtree("dist")
run("python -m build")
wheel_dist = glob.glob(os.path.join("dist", "*.whl"))[0]
run("pip install %s" % wheel_dist)
